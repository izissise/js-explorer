# some options from https://github.com/h5bp/server-configs-nginx/tree/main
# basic cookie auth https://gist.github.com/eatnumber1/92e94086dafc7194077df4a6b45b2b75
gzip on;
gzip_comp_level 5;
gzip_min_length 256;
gzip_proxied any;
gzip_vary on;
gzip_types text/javascript text/plain application/javascript application/x-javascript;

open_file_cache max=1000 inactive=20s;
open_file_cache_valid 30s;
open_file_cache_min_uses 2;
open_file_cache_errors on;

sendfile           on;
sendfile_max_chunk 2m;
tcp_nopush         on;
tcp_nodelay        on;
keepalive_timeout  65;

# include mime.types;
types {
    video/x-matroska mkv;
}

# CORS
add_header Access-Control-Allow-Origin *;
add_header Access-Control-Allow-Methods *;

add_header X-Content-Type-Options nosniff always;
add_header X-Frame-Options SAMEORIGIN always;
server_tokens off;

charset UTF-8;
charset_types text/css text/plain text/vnd.wap.wml text/javascript text/markdown application/json application/manifest+json;

# Config
map "" $ngxp_endpoint {
    default ___ngxp;
}
map "" $ngxp_html_header {
    default "<!DOCTYPE html><html><link rel='shortcut icon' href='data:;base64,=' /><link rel='stylesheet' href='/$ngxp_endpoint/main.css' /><script name='NgxEx' favicon='🗃️' auth=$sca_auth_passed logout='/$ngxp_endpoint/logout' upload='/$ngxp_endpoint/upload/' upload-max-size='209715200' icons='/$ngxp_endpoint/icons/' src='/$ngxp_endpoint/main.js'></script>";
}

# Cookies
map $sca_auth_passed $sca_authorized_realm {
    "yes" "off";
    default "$sca_realm";
}
# Don't send the cookie if the client already had it. This should allow the one
# already there to expire normally.
map $sca_authorized_realm $sca_authorized_cookie {
    "off" "";
    default "nginx_explorer=$sca_token; max-age=$sca_token_max_age; path=/; SameSite=Lax; Secure; HttpOnly";
}

# inject html on all requests
# except a file download will not end with a '/'
# so here we make sure we only replace '<html>'
# for actual file listing
map $uri $cond_filter {
    ~/$ $ngxp_html_header;
    default "<html>";
}

server {
    set $sca_auth_passed "no";

    # Listen on http port
    listen 8080;

    # Serve files listing
    location / {
        # Path to serve
        root /home/user/downloads;

        add_header Access-Control-Expose-Headers 'Content-Length';
        add_header Access-Control-Expose-Headers 'Content-Disposition';

        # Auth
        set $sca_realm "Private file";
        set $sca_token "secret";
        set $sca_token_max_age 15552000;
        if ($cookie_nginx_explorer = $sca_token) {
            set $sca_auth_passed "yes";
        }
        auth_basic $sca_authorized_realm;
        auth_delay 1s;
        auth_basic_user_file /basic_auth/download.htpasswd;
        add_header Set-Cookie $sca_authorized_cookie;
        error_page 401 = @unprompt; # prevent basic auth browser prompt

        # Random id so nginx doesn't serve random html files
        # that browsers would render, you can remove this line
        # if you want directories with index.html to be rendered
        index 953b12d3-5ab2-49ad-8f49-6ea27f3a9994;

        # File listing (index) in html format
        autoindex on;
        autoindex_format html;
        autoindex_exact_size on;

        sub_filter_once on;
        sub_filter "<html>" $cond_filter;
    }

    location @unprompt {
        ## override content-type ##
        types { } default_type "text/html; charset=utf-8";
        return 403 $ngxp_html_header;
    }

    # this is where app files (main.js, icons) are,
    # drawback is that a folder named '___ngxp' cannot be indexed
    location ^~ /___ngxp/ {
        alias /var/www/ngxp/;
    }

    # logout cookie
    location ^~ /___ngxp/logout {
        limit_except POST {
            deny all;
        }
        add_header Set-Cookie "nginx_explorer=; Max-Age=0; path=/; SameSite=Lax; Secure; HttpOnly";
        return 200 "logged out";
    }

    # Upload endpoint
    location ^~ /___ngxp/upload/ {
        limit_except GET POST {
            deny all;
        }

        # Where to store the files on disk
        client_body_temp_path      /home/user/uploads/;
        # Store the file on disk, and don't delete it, no matter
        # what the proxy returns.
        client_body_in_file_only   on;
        client_body_buffer_size    16m;
        client_max_body_size       256m;
        # Give the client 2h to upload.
        client_body_timeout        2h;

        # Now proxy to the small internal server we started
        # below, and don't pass the uploaded file to it.
        proxy_set_body             off;
        proxy_pass                 http://127.0.0.1:4000/$request_method;


        auth_basic           "Upload files";
        auth_delay           1s;
        auth_basic_user_file /basic_auth/upload.htpasswd;
        error_page 401 = @unprompt; # prevent basic auth browser prompt
    }
}

# Dummy server that return 200 to finish files upload
server {
    listen 127.0.0.1:4000;

    location /POST {
        return 204;
    }

    location /GET {
        return 200;
    }
}
