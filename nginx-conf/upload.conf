server {
    # Listen on http port
    listen 80;

    # Serve files listing
    location ^~ /files/ {
        # Path to serve (Trailing slash is important)
        alias /home/user/downloads/;

        # Random id so nginx doesn't serve random html files
        # that browsers would render, you can remove this line
        # if you want directories with index.html to be rendered
        index 953b12d3-5ab2-49ad-8f49-6ea27f3a9999;

        # File listing (index) in json format
        autoindex on;
        autoindex_format json;
        autoindex_exact_size on;

        # Perf tuning
        sendfile           on;
        sendfile_max_chunk 2m;
        tcp_nopush         on;
        tcp_nodelay        on;
        keepalive_timeout  65;

    }

    # Serve root html/js/css files
    location / {
        root /var/www/files/;
        # Try files makes nginx serves root files on all sub-paths
        try_files $uri $uri/ /index.html;

        # Perf tuning
        sendfile           on;
        sendfile_max_chunk 2m;
        tcp_nopush         on;
        tcp_nodelay        on;
        keepalive_timeout  65;
    }

    # Upload location
    location ^~ /upload/ {
        limit_except GET POST {
            deny all;
        }

        # Where to store the files on disk
        client_body_temp_path      /home/user/uploads/;
        # Store the file on disk, and don't delete it, no matter
        # what the proxy returns.
        client_body_in_file_only   on;
        client_body_buffer_size    2m;
        client_max_body_size       10g;
        # Give the client 2h to upload.
        client_body_timeout        2h;

        # Now proxy to the small internal server we started
        # below, and don't pass the uploaded file to it.
        proxy_set_body             off;
        proxy_pass                 http://127.0.0.1:4000/$request_method;

    }
}

# Dummy server that return 200 to finish files upload
server {
    listen 127.0.0.1:4000;

    location /POST {
        return 204;
    }

    location /GET {
        return 200;
    }
}
